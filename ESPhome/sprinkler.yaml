esphome:
  name: sprinkler-1
  friendly_name: "Sprinkler"
  # Безопасность: Принудительное выключение реле при загрузке чипа
  on_boot:
    priority: 1000
    then:
      - output.turn_off: relay_pin
      - lambda: 'id(sprinkler_logic_switch).publish_state(false);'

esp32:
  board: esp32-c3-devkitm-1

# Логирование для диагностики (Execution blocked и т.д.)
logger:
  level: DEBUG

# Глобальная переменная для кулдауна (защита от спама командами)
globals:
  - id: cooldown_active
    type: bool
    restore_value: no
    initial_value: 'false'

wifi:
  ssid: "ВАШ_SSID"
  password: "ВАШ_ПАРОЛЬ"
  ap:
    ssid: "Sprinkler Fallback"

api:
ota:
  platform: esphome

# 1. Выход для реле
output:
  - platform: gpio
    pin: 
      number: 8
      mode:
        output: true
        open_drain: true
    id: relay_pin
    # Выставлено в false для реле с High Level Trigger
    inverted: false 

# 2. Слайдер длительности полива
number:
  - platform: template
    name: "Watering Duration"
    id: water_duration
    optimistic: true
    min_value: 3
    max_value: 12
    step: 1
    initial_value: 3
    unit_of_measurement: "sec"
    icon: "mdi:timer-sand"
    mode: slider

# 3. Виртуальный выключатель для интерфейса и Google Home
switch:
  - platform: template
    name: "Sprinkler Switch"
    id: sprinkler_logic_switch
    icon: "mdi:water-pump"
    turn_on_action:
      - if:
          condition:
            # Запуск только если скрипт НЕ работает и кулдаун НЕ активен
            lambda: |-
              return !id(water_cycle_script).is_running() && !id(cooldown_active);
          then:
            - script.execute: water_cycle_script
          else:
            # Если запуск заблокирован — принудительно возвращаем кнопку в OFF в UI
            - lambda: 'id(sprinkler_logic_switch).publish_state(false);'
            - logger.log: "Execution blocked: Cool-down active or script already running"
    turn_off_action:
      # Ручной стоп
      - script.stop: water_cycle_script
      - output.turn_off: relay_pin
      - lambda: 'id(sprinkler_logic_switch).publish_state(false);'

# 4. Основной скрипт полива
script:
  - id: water_cycle_script
    mode: single 
    then:
      # --- СТАРТ ---
      - output.turn_on: relay_pin
      - lambda: 'id(sprinkler_logic_switch).publish_state(true);'
      
      # --- ОЖИДАНИЕ (время из слайдера) ---
      - delay: !lambda "return id(water_duration).state * 1000;"
      
      # --- СТОП (основной) ---
      - output.turn_off: relay_pin
      - lambda: 'id(sprinkler_logic_switch).publish_state(false);'
      
      # --- КУЛДАУН И ПОДСТРАХОВКА ---
      - lambda: 'id(cooldown_active) = true;'
      - logger.log: "Cool-down interval started"
      
      # Повторная команда на выключение на случай помех
      - output.turn_off: relay_pin 
      
      - delay: 5s
      
      - lambda: 'id(cooldown_active) = false;'
      - logger.log: "Cool-down interval finished"
      
      # Финальная синхронизация состояния
      - lambda: 'id(sprinkler_logic_switch).publish_state(false);'
